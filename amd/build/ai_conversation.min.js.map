{"version":3,"file":"ai_conversation.min.js","sources":["../src/ai_conversation.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * AMD module for AI conversation chat interface.\n *\n * @module     mod_harpiasurvey/ai_conversation\n * @copyright  2025 Your Name\n * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport Config from 'core/config';\nimport $ from 'jquery';\n\nlet initialized = false;\n\n/**\n * Initialize the AI conversation functionality.\n */\nexport const init = () => {\n    if (initialized) {\n        return;\n    }\n\n    // Handle send button clicks.\n    $(document).on('click', '.chat-send-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const questionid = parseInt(button.data('questionid'), 10);\n        const cmid = parseInt(button.data('cmid'), 10);\n        const pageid = parseInt(button.data('pageid'), 10);\n\n        const input = $(`#chat-input-${questionid}`);\n        const message = input.val().trim();\n\n        if (!message) {\n            return;\n        }\n\n        // Get model from container data attribute (first available model).\n        const container = $(`.ai-conversation-container[data-questionid=\"${questionid}\"]`);\n        const modelsdata = container.data('models');\n        let modelid = null;\n\n        if (modelsdata) {\n            // modelsdata is a comma-separated string, get first one.\n            const modelids = modelsdata.split(',');\n            if (modelids.length > 0) {\n                modelid = parseInt(modelids[0], 10);\n            }\n        }\n\n        if (!modelid) {\n            Notification.addNotification({\n                message: 'No model available',\n                type: 'error'\n            });\n            return;\n        }\n\n        // Disable input and button.\n        input.prop('disabled', true);\n        button.prop('disabled', true);\n\n        // Clear input.\n        input.val('');\n\n        // Display user message with temporary ID (will be updated with real ID from server).\n        const tempId = 'temp-user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n        displayUserMessage(questionid, message, tempId);\n\n        // Show loading indicator.\n        const loading = $(`#chat-loading-${questionid}`);\n        loading.show();\n\n        // Send message to AI.\n        sendMessage(cmid, pageid, questionid, message, modelid, button, input, loading);\n    });\n\n    // Handle Enter key in textarea (Shift+Enter for new line, Enter to send).\n    $(document).on('keydown', '.chat-input', function(e) {\n        if (e.key === 'Enter' && !e.shiftKey) {\n            e.preventDefault();\n            $(this).closest('.ai-conversation-container').find('.chat-send-btn').click();\n        }\n    });\n\n    initialized = true;\n};\n\n/**\n * Display user message in chat.\n *\n * @param {number} questionid Question ID\n * @param {string} message Message content\n * @param {number} messageid Optional message ID to prevent duplicates\n */\nconst displayUserMessage = (questionid, message, messageid = null) => {\n    const messagesContainer = $(`#chat-messages-${questionid}`);\n    const placeholder = messagesContainer.find('.text-muted.text-center');\n\n    if (placeholder.length > 0) {\n        placeholder.remove();\n    }\n\n    // Check if message already exists (by ID).\n    if (messageid) {\n        const existing = messagesContainer.find(`[data-messageid=\"${messageid}\"]`);\n        if (existing.length > 0) {\n            return; // Message already displayed.\n        }\n    }\n\n    // Also check for duplicate content in the last few messages (prevent double-sending).\n    const recentMessages = messagesContainer.find('.message').slice(-3);\n    let isDuplicate = false;\n    recentMessages.each(function() {\n        const msgContent = $(this).find('.content').text().trim();\n        if (msgContent === message.trim()) {\n            isDuplicate = true;\n            return false; // Break loop.\n        }\n    });\n    if (isDuplicate && !messageid) {\n        // If it's a duplicate and no ID provided, don't add it.\n        return;\n    }\n\n    // Double-check for duplicate before rendering (race condition protection).\n    if (messageid) {\n        const existing = messagesContainer.find(`[data-messageid=\"${messageid}\"]`);\n        if (existing.length > 0) {\n            return; // Message already displayed.\n        }\n    }\n\n    Templates.render('mod_harpiasurvey/chat_user_message', {\n        content: message,\n        id: messageid || 'temp-' + Date.now()\n    }).then((html) => {\n        // Final check before appending (prevent race conditions).\n        if (messageid) {\n            const existing = messagesContainer.find(`[data-messageid=\"${messageid}\"]`);\n            if (existing.length > 0) {\n                return; // Message was added while we were rendering.\n            }\n        }\n        Templates.appendNodeContents(messagesContainer[0], html);\n        // Scroll after a brief delay to ensure DOM is fully updated.\n        setTimeout(() => {\n            scrollToBottom(questionid);\n        }, 50);\n    }).catch(() => {\n        // Fallback if template fails.\n        // Final check before appending.\n        if (messageid) {\n            const existing = messagesContainer.find(`[data-messageid=\"${messageid}\"]`);\n            if (existing.length > 0) {\n                return;\n            }\n        }\n        const messageHtml = '<div class=\"message my-3\" data-messageid=\"' + (messageid || 'temp-' + Date.now()) + '\">' +\n            '<div class=\"d-flex justify-content-end\">' +\n            '<div class=\"border rounded p-2 bg-primary text-white\" style=\"max-width: 80%;\">' +\n            '<div class=\"content\">' + message + '</div>' +\n            '</div></div></div>';\n        messagesContainer.append(messageHtml);\n        // Scroll after a brief delay to ensure DOM is fully updated.\n        setTimeout(() => {\n            scrollToBottom(questionid);\n        }, 50);\n    });\n};\n\n/**\n * Display AI message in chat.\n *\n * @param {number} questionid Question ID\n * @param {string} content Message content\n * @param {number} messageid Message ID\n */\nconst displayAIMessage = (questionid, content, messageid) => {\n    const messagesContainer = $(`#chat-messages-${questionid}`);\n\n    if (!messageid) {\n        // eslint-disable-next-line no-console\n        console.error('displayAIMessage called without messageid');\n        return;\n    }\n\n    if (!content) {\n        // eslint-disable-next-line no-console\n        console.error('displayAIMessage called without content');\n        return;\n    }\n\n    // Check if message already exists.\n    const existing = messagesContainer.find(`[data-messageid=\"${messageid}\"]`);\n    if (existing.length > 0) {\n        // eslint-disable-next-line no-console\n        console.log('AI message already displayed:', messageid);\n        return; // Message already displayed.\n    }\n\n    Templates.render('mod_harpiasurvey/chat_ai_message', {\n        id: messageid,\n        content: content\n    }).then((html) => {\n        // Final check before appending (prevent race conditions).\n        const existingCheck = messagesContainer.find(`[data-messageid=\"${messageid}\"]`);\n        if (existingCheck.length > 0) {\n            return; // Message was added while we were rendering.\n        }\n        Templates.appendNodeContents(messagesContainer[0], html);\n        // Scroll after a brief delay to ensure DOM is fully updated.\n        setTimeout(() => {\n            scrollToBottom(questionid);\n        }, 50);\n    }).catch(() => {\n        // Fallback if template fails.\n        // Final check before appending.\n        const existingCheck = messagesContainer.find(`[data-messageid=\"${messageid}\"]`);\n        if (existingCheck.length > 0) {\n            return;\n        }\n        const messageHtml = '<div class=\"message my-3\" data-messageid=\"' + messageid + '\">' +\n            '<div class=\"d-flex\">' +\n            '<div class=\"border rounded p-2 bg-light\" style=\"max-width: 80%;\">' +\n            '<div class=\"content\">' + content + '</div>' +\n            '</div></div></div>';\n        messagesContainer.append(messageHtml);\n        // Scroll after a brief delay to ensure DOM is fully updated.\n        setTimeout(() => {\n            scrollToBottom(questionid);\n        }, 50);\n    });\n};\n\n/**\n * Send message to AI via AJAX.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n * @param {number} questionid Question ID\n * @param {string} message Message content\n * @param {number} modelid Model ID\n * @param {jQuery} button Send button element\n * @param {jQuery} input Input textarea element\n * @param {jQuery} loading Loading indicator element\n */\nconst sendMessage = (cmid, pageid, questionid, message, modelid, button, input, loading) => {\n    const params = new URLSearchParams({\n        action: 'send_ai_message',\n        cmid: cmid,\n        pageid: pageid,\n        questionid: questionid,\n        message: message,\n        modelid: modelid,\n        sesskey: Config.sesskey\n    });\n\n    fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n        method: 'GET',\n        headers: {\n            'Content-Type': 'application/json'\n        }\n    })\n    .then(response => {\n        if (!response.ok) {\n            throw new Error('HTTP error! status: ' + response.status);\n        }\n        return response.json();\n    })\n    .then(data => {\n        loading.hide();\n\n        if (data.success) {\n            // Update user message with actual ID from server (if we have parentid).\n            if (data.parentid) {\n                // Find the last user message (the one we just sent) and update its ID.\n                const messagesContainer = $(`#chat-messages-${questionid}`);\n                const userMessages = messagesContainer.find('.message').filter(function() {\n                    return $(this).find('.bg-primary').length > 0;\n                });\n                if (userMessages.length > 0) {\n                    const lastUserMsg = userMessages.last();\n                    const currentId = lastUserMsg.attr('data-messageid');\n                    // Only update if it's a temporary ID.\n                    if (currentId && currentId.startsWith('temp-')) {\n                        lastUserMsg.attr('data-messageid', data.parentid);\n                    }\n                }\n            }\n\n            // Display AI response (check for duplicates first).\n            if (data.messageid && data.content) {\n                displayAIMessage(questionid, data.content, data.messageid);\n            } else {\n                Notification.addNotification({\n                    message: 'Received response but missing message ID or content',\n                    type: 'error'\n                });\n            }\n        } else {\n            Notification.addNotification({\n                message: data.message || 'Error sending message',\n                type: 'error'\n            });\n        }\n\n        // Re-enable input and button.\n        input.prop('disabled', false);\n        button.prop('disabled', false);\n        input.focus();\n    })\n    .catch(error => {\n        loading.hide();\n        // eslint-disable-next-line no-console\n        console.error('Error sending message:', error);\n        Notification.addNotification({\n            message: 'Error sending message: ' + error.message,\n            type: 'error'\n        });\n        input.prop('disabled', false);\n        button.prop('disabled', false);\n        input.focus();\n    });\n};\n\n/**\n * Scroll chat to bottom.\n *\n * @param {number} questionid Question ID\n */\nconst scrollToBottom = (questionid) => {\n    const messagesContainer = $(`#chat-messages-${questionid}`);\n    if (messagesContainer.length === 0) {\n        return;\n    }\n\n    // Use requestAnimationFrame to ensure DOM is updated before scrolling.\n    requestAnimationFrame(() => {\n        const container = messagesContainer[0];\n        if (container) {\n            container.scrollTop = container.scrollHeight;\n        }\n    });\n};\n"],"names":["initialized","document","on","e","preventDefault","button","this","questionid","parseInt","data","cmid","pageid","input","message","val","trim","modelsdata","modelid","modelids","split","length","addNotification","type","prop","tempId","Date","now","Math","random","toString","substr","displayUserMessage","loading","show","sendMessage","key","shiftKey","closest","find","click","messageid","messagesContainer","placeholder","remove","recentMessages","slice","isDuplicate","each","text","render","content","id","then","html","appendNodeContents","setTimeout","scrollToBottom","catch","messageHtml","append","params","URLSearchParams","action","sesskey","Config","fetch","wwwroot","method","headers","response","ok","Error","status","json","hide","success","parentid","userMessages","filter","lastUserMsg","last","currentId","attr","startsWith","console","error","log","displayAIMessage","focus","requestAnimationFrame","container","scrollTop","scrollHeight"],"mappings":";;;;;;;wQA4BIA,aAAc,gBAKE,KACZA,kCAKFC,UAAUC,GAAG,QAAS,kBAAkB,SAASC,GAC/CA,EAAEC,uBACIC,QAAS,mBAAEC,MACXC,WAAaC,SAASH,OAAOI,KAAK,cAAe,IACjDC,KAAOF,SAASH,OAAOI,KAAK,QAAS,IACrCE,OAASH,SAASH,OAAOI,KAAK,UAAW,IAEzCG,OAAQ,yCAAiBL,aACzBM,QAAUD,MAAME,MAAMC,WAEvBF,qBAMCG,YADY,yEAAiDT,kBACtCE,KAAK,cAC9BQ,QAAU,QAEVD,WAAY,OAENE,SAAWF,WAAWG,MAAM,KAC9BD,SAASE,OAAS,IAClBH,QAAUT,SAASU,SAAS,GAAI,SAInCD,0CACYI,gBAAgB,CACzBR,QAAS,qBACTS,KAAM,UAMdV,MAAMW,KAAK,YAAY,GACvBlB,OAAOkB,KAAK,YAAY,GAGxBX,MAAME,IAAI,UAGJU,OAAS,aAAeC,KAAKC,MAAQ,IAAMC,KAAKC,SAASC,SAAS,IAAIC,OAAO,EAAG,GACtFC,mBAAmBxB,WAAYM,QAASW,cAGlCQ,SAAU,2CAAmBzB,aACnCyB,QAAQC,OAGRC,YAAYxB,KAAMC,OAAQJ,WAAYM,QAASI,QAASZ,OAAQO,MAAOoB,gCAIzE/B,UAAUC,GAAG,UAAW,eAAe,SAASC,GAChC,UAAVA,EAAEgC,KAAoBhC,EAAEiC,WACxBjC,EAAEC,qCACAE,MAAM+B,QAAQ,8BAA8BC,KAAK,kBAAkBC,YAI7EvC,aAAc,UAUZ+B,mBAAqB,SAACxB,WAAYM,aAAS2B,iEAAY,WACnDC,mBAAoB,4CAAoBlC,aACxCmC,YAAcD,kBAAkBH,KAAK,8BAEvCI,YAAYtB,OAAS,GACrBsB,YAAYC,SAIZH,UAAW,IACMC,kBAAkBH,gCAAyBE,iBAC/CpB,OAAS,eAMpBwB,eAAiBH,kBAAkBH,KAAK,YAAYO,OAAO,OAC7DC,aAAc,KAClBF,eAAeG,MAAK,eACG,mBAAEzC,MAAMgC,KAAK,YAAYU,OAAOjC,SAChCF,QAAQE,cACvB+B,aAAc,GACP,MAGXA,aAAgBN,cAMhBA,UAAW,IACMC,kBAAkBH,gCAAyBE,iBAC/CpB,OAAS,4BAKhB6B,OAAO,qCAAsC,CACnDC,QAASrC,QACTsC,GAAIX,WAAa,QAAUf,KAAKC,QACjC0B,MAAMC,UAEDb,UAAW,IACMC,kBAAkBH,gCAAyBE,iBAC/CpB,OAAS,4BAIhBkC,mBAAmBb,kBAAkB,GAAIY,MAEnDE,YAAW,KACPC,eAAejD,cAChB,OACJkD,OAAM,QAGDjB,UAAW,IACMC,kBAAkBH,gCAAyBE,iBAC/CpB,OAAS,eAIpBsC,YAAc,8CAAgDlB,WAAa,QAAUf,KAAKC,OAA5E,gJAGUb,QAHV,2BAKpB4B,kBAAkBkB,OAAOD,aAEzBH,YAAW,KACPC,eAAejD,cAChB,SAgFL2B,YAAc,CAACxB,KAAMC,OAAQJ,WAAYM,QAASI,QAASZ,OAAQO,MAAOoB,iBACtE4B,OAAS,IAAIC,gBAAgB,CAC/BC,OAAQ,kBACRpD,KAAMA,KACNC,OAAQA,OACRJ,WAAYA,WACZM,QAASA,QACTI,QAASA,QACT8C,QAASC,gBAAOD,UAGpBE,MAAMD,gBAAOE,QAAU,8BAAgCN,OAAO/B,WAAY,CACtEsC,OAAQ,MACRC,QAAS,gBACW,sBAGvBhB,MAAKiB,eACGA,SAASC,SACJ,IAAIC,MAAM,uBAAyBF,SAASG,eAE/CH,SAASI,UAEnBrB,MAAK3C,UACFuB,QAAQ0C,OAEJjE,KAAKkE,QAAS,IAEVlE,KAAKmE,SAAU,OAGTC,cADoB,4CAAoBtE,aACP+B,KAAK,YAAYwC,QAAO,kBACpD,mBAAExE,MAAMgC,KAAK,eAAelB,OAAS,QAE5CyD,aAAazD,OAAS,EAAG,OACnB2D,YAAcF,aAAaG,OAC3BC,UAAYF,YAAYG,KAAK,kBAE/BD,WAAaA,UAAUE,WAAW,UAClCJ,YAAYG,KAAK,iBAAkBzE,KAAKmE,WAMhDnE,KAAK+B,WAAa/B,KAAKyC,QAlHd,EAAC3C,WAAY2C,QAASV,mBACrCC,mBAAoB,4CAAoBlC,iBAEzCiC,sBAED4C,QAAQC,MAAM,iDAIbnC,oBAEDkC,QAAQC,MAAM,2CAKD5C,kBAAkBH,gCAAyBE,iBAC/CpB,OAAS,EAElBgE,QAAQE,IAAI,gCAAiC9C,8BAIvCS,OAAO,mCAAoC,CACjDE,GAAIX,UACJU,QAASA,UACVE,MAAMC,OAEiBZ,kBAAkBH,gCAAyBE,iBAC/CpB,OAAS,uBAGjBkC,mBAAmBb,kBAAkB,GAAIY,MAEnDE,YAAW,KACPC,eAAejD,cAChB,QACJkD,OAAM,QAGiBhB,kBAAkBH,gCAAyBE,iBAC/CpB,OAAS,eAGrBsC,YAAc,6CAA+ClB,UAA/C,+GAGUU,QAHV,2BAKpBT,kBAAkBkB,OAAOD,aAEzBH,YAAW,KACPC,eAAejD,cAChB,QA8DKgF,CAAiBhF,WAAYE,KAAKyC,QAASzC,KAAK+B,iCAEnCnB,gBAAgB,CACzBR,QAAS,sDACTS,KAAM,qCAIDD,gBAAgB,CACzBR,QAASJ,KAAKI,SAAW,wBACzBS,KAAM,UAKdV,MAAMW,KAAK,YAAY,GACvBlB,OAAOkB,KAAK,YAAY,GACxBX,MAAM4E,WAET/B,OAAM4B,QACHrD,QAAQ0C,OAERU,QAAQC,MAAM,yBAA0BA,6BAC3BhE,gBAAgB,CACzBR,QAAS,0BAA4BwE,MAAMxE,QAC3CS,KAAM,UAEVV,MAAMW,KAAK,YAAY,GACvBlB,OAAOkB,KAAK,YAAY,GACxBX,MAAM4E,YASRhC,eAAkBjD,mBACdkC,mBAAoB,4CAAoBlC,aACb,IAA7BkC,kBAAkBrB,QAKtBqE,uBAAsB,WACZC,UAAYjD,kBAAkB,GAChCiD,YACAA,UAAUC,UAAYD,UAAUE"}