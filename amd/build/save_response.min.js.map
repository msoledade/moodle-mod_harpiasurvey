{"version":3,"file":"save_response.min.js","sources":["../src/save_response.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Save response module for harpiasurvey.\n *\n * @module     mod_harpiasurvey/save_response\n * @copyright  2025 Your Name\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\nimport Config from 'core/config';\nimport $ from 'jquery';\n\nlet initialized = false;\n\n/**\n * Initialize the save response functionality.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n */\nexport const init = (cmid, pageid) => {\n    if (initialized) {\n        return;\n    }\n\n    // Pre-populate select dropdowns with saved values.\n    $('select[data-saved-value]').each(function() {\n        const select = $(this);\n        const savedValue = select.data('saved-value');\n        if (savedValue) {\n            select.val(savedValue);\n        }\n    });\n\n    // Handle save button clicks.\n    $(document).on('click', '.save-response-btn', function(e) {\n        e.preventDefault();\n        const button = $(this);\n        const questionid = parseInt(button.data('questionid'), 10);\n        const questiontype = button.data('questiontype');\n\n        // Get the response value based on question type.\n        let response = '';\n\n        if (questiontype === 'singlechoice' || questiontype === 'likert') {\n            // Radio button: get selected value.\n            const selected = $(`input[name=\"question_${questionid}\"]:checked`);\n            if (selected.length > 0) {\n                response = selected.val();\n            }\n        } else if (questiontype === 'multiplechoice') {\n            // Checkboxes: get all selected values as JSON array.\n            const selected = $(`input[name=\"question_${questionid}[]\"]:checked`);\n            const values = [];\n            selected.each(function() {\n                values.push($(this).val());\n            });\n            response = JSON.stringify(values);\n        } else if (questiontype === 'select') {\n            // Select dropdown: get selected value.\n            const selected = $(`#question_${questionid}`).val();\n            if (selected) {\n                response = selected;\n            }\n        } else if (questiontype === 'number' || questiontype === 'shorttext') {\n            // Number or short text: get input value.\n            response = $(`#question_${questionid}`).val();\n        } else if (questiontype === 'longtext') {\n            // Long text: get textarea value.\n            response = $(`#question_${questionid}`).val();\n        }\n\n        // Save the response via AJAX.\n        saveResponse(cmid, pageid, questionid, response, button);\n    });\n\n    initialized = true;\n};\n\n/**\n * Save response via AJAX.\n *\n * @param {number} cmid Course module ID\n * @param {number} pageid Page ID\n * @param {number} questionid Question ID\n * @param {string} response Response value\n * @param {jQuery} button Save button element\n */\nconst saveResponse = (cmid, pageid, questionid, response, button) => {\n    const originalText = button.text();\n    button.prop('disabled', true);\n    getString('saving', 'mod_harpiasurvey').then((savingText) => {\n        button.text(savingText);\n\n        const params = new URLSearchParams({\n            action: 'save_response',\n            cmid: cmid,\n            pageid: pageid,\n            questionid: questionid,\n            response: response,\n            sesskey: Config.sesskey\n        });\n\n        fetch(Config.wwwroot + '/mod/harpiasurvey/ajax.php?' + params.toString(), {\n            method: 'GET',\n            headers: {\n                'Content-Type': 'application/json'\n            }\n        })\n        .then(response => response.json())\n        .then(data => {\n            if (data.success) {\n                // Show success message.\n                getString('saved', 'mod_harpiasurvey').then((savedText) => {\n                    button.text(savedText);\n                    button.removeClass('btn-primary').addClass('btn-success');\n\n                    // Update or show saved message with timestamp.\n                    const savedMessage = $(`.saved-response-message[data-questionid=\"${questionid}\"]`);\n                    if (savedMessage.length === 0) {\n                        // Create new message element.\n                        const now = new Date();\n                        const datetimeStr = now.toLocaleString();\n                        getString('on', 'mod_harpiasurvey').then((onText) => {\n                            const messageHtml = '<div class=\"mt-1 small text-muted saved-response-message\" ' +\n                                `data-questionid=\"${questionid}\">` +\n                                '<i class=\"fa fa-check-circle\" aria-hidden=\"true\"></i> ' +\n                                `${savedText} ${onText} ${datetimeStr}</div>`;\n                            button.after(messageHtml);\n                        });\n                    } else {\n                        // Update existing message timestamp.\n                        const now = new Date();\n                        const datetimeStr = now.toLocaleString();\n                        getString('on', 'mod_harpiasurvey').then((onText) => {\n                            const icon = '<i class=\"fa fa-check-circle\" aria-hidden=\"true\"></i>';\n                            savedMessage.html(`${icon} ${savedText} ${onText} ${datetimeStr}`);\n                        });\n                    }\n\n                    // Reset button after 2 seconds.\n                    setTimeout(() => {\n                        button.prop('disabled', false);\n                        button.text(originalText);\n                        button.removeClass('btn-success').addClass('btn-primary');\n                    }, 2000);\n                });\n            } else {\n                Notification.addNotification({\n                    message: data.message || 'Error saving response',\n                    type: 'error'\n                });\n                button.prop('disabled', false);\n                button.text(originalText);\n            }\n        })\n        .catch(error => {\n            Notification.addNotification({\n                message: 'Error saving response: ' + error.message,\n                type: 'error'\n            });\n            button.prop('disabled', false);\n            button.text(originalText);\n        });\n    });\n};\n\n"],"names":["initialized","cmid","pageid","each","select","this","savedValue","data","val","document","on","e","preventDefault","button","questionid","parseInt","questiontype","response","selected","length","values","push","JSON","stringify","saveResponse","originalText","text","prop","then","savingText","params","URLSearchParams","action","sesskey","Config","fetch","wwwroot","toString","method","headers","json","success","savedText","removeClass","addClass","savedMessage","datetimeStr","Date","toLocaleString","onText","messageHtml","after","html","setTimeout","addNotification","message","type","catch","error"],"mappings":";;;;;;;0NA4BIA,aAAc,gBAQE,CAACC,KAAMC,UACnBF,kCAKF,4BAA4BG,MAAK,iBACzBC,QAAS,mBAAEC,MACXC,WAAaF,OAAOG,KAAK,eAC3BD,YACAF,OAAOI,IAAIF,mCAKjBG,UAAUC,GAAG,QAAS,sBAAsB,SAASC,GACnDA,EAAEC,uBACIC,QAAS,mBAAER,MACXS,WAAaC,SAASF,OAAON,KAAK,cAAe,IACjDS,aAAeH,OAAON,KAAK,oBAG7BU,SAAW,MAEM,iBAAjBD,cAAoD,WAAjBA,aAA2B,OAExDE,UAAW,kDAA0BJ,0BACvCI,SAASC,OAAS,IAClBF,SAAWC,SAASV,YAErB,GAAqB,mBAAjBQ,aAAmC,OAEpCE,UAAW,kDAA0BJ,4BACrCM,OAAS,GACfF,SAASf,MAAK,WACViB,OAAOC,MAAK,mBAAEhB,MAAMG,UAExBS,SAAWK,KAAKC,UAAUH,aACvB,GAAqB,WAAjBJ,aAA2B,OAE5BE,UAAW,uCAAeJ,aAAcN,MAC1CU,WACAD,SAAWC,eAES,WAAjBF,cAA8C,cAAjBA,cAGZ,aAAjBA,gBADPC,UAAW,uCAAeH,aAAcN,OAO5CgB,aAAavB,KAAMC,OAAQY,WAAYG,SAAUJ,WAGrDb,aAAc,UAYZwB,aAAe,CAACvB,KAAMC,OAAQY,WAAYG,SAAUJ,gBAChDY,aAAeZ,OAAOa,OAC5Bb,OAAOc,KAAK,YAAY,uBACd,SAAU,oBAAoBC,MAAMC,aAC1ChB,OAAOa,KAAKG,kBAENC,OAAS,IAAIC,gBAAgB,CAC/BC,OAAQ,gBACR/B,KAAMA,KACNC,OAAQA,OACRY,WAAYA,WACZG,SAAUA,SACVgB,QAASC,gBAAOD,UAGpBE,MAAMD,gBAAOE,QAAU,8BAAgCN,OAAOO,WAAY,CACtEC,OAAQ,MACRC,QAAS,gBACW,sBAGvBX,MAAKX,UAAYA,SAASuB,SAC1BZ,MAAKrB,OACEA,KAAKkC,4BAEK,QAAS,oBAAoBb,MAAMc,YACzC7B,OAAOa,KAAKgB,WACZ7B,OAAO8B,YAAY,eAAeC,SAAS,qBAGrCC,cAAe,sEAA8C/B,qBACvC,IAAxB+B,aAAa1B,OAAc,OAGrB2B,aADM,IAAIC,MACQC,qCACd,KAAM,oBAAoBpB,MAAMqB,eAChCC,YAAc,wFACIpC,iBACpB,mEACG4B,sBAAaO,mBAAUH,sBAC9BjC,OAAOsC,MAAMD,oBAEd,OAGGJ,aADM,IAAIC,MACQC,qCACd,KAAM,oBAAoBpB,MAAMqB,SAEtCJ,aAAaO,eADA,oEACgBV,sBAAaO,mBAAUH,iBAK5DO,YAAW,KACPxC,OAAOc,KAAK,YAAY,GACxBd,OAAOa,KAAKD,cACZZ,OAAO8B,YAAY,eAAeC,SAAS,iBAC5C,+BAGMU,gBAAgB,CACzBC,QAAShD,KAAKgD,SAAW,wBACzBC,KAAM,UAEV3C,OAAOc,KAAK,YAAY,GACxBd,OAAOa,KAAKD,kBAGnBgC,OAAMC,8BACUJ,gBAAgB,CACzBC,QAAS,0BAA4BG,MAAMH,QAC3CC,KAAM,UAEV3C,OAAOc,KAAK,YAAY,GACxBd,OAAOa,KAAKD"}