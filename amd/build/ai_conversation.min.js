define("mod_harpiasurvey/ai_conversation",["exports","core/templates","core/notification","core/config","jquery"],(function(_exports,_templates,_notification,_config,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * AMD module for AI conversation chat interface.
   *
   * @module     mod_harpiasurvey/ai_conversation
   * @copyright  2025 Your Name
   * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),_config=_interopRequireDefault(_config),_jquery=_interopRequireDefault(_jquery);let initialized=!1;_exports.init=()=>{initialized||((0,_jquery.default)(document).on("click",".chat-send-btn",(function(e){e.preventDefault();const button=(0,_jquery.default)(this),questionid=parseInt(button.data("questionid"),10),cmid=parseInt(button.data("cmid"),10),pageid=parseInt(button.data("pageid"),10),input=(0,_jquery.default)("#chat-input-".concat(questionid)),message=input.val().trim();if(!message)return;const modelsdata=(0,_jquery.default)('.ai-conversation-container[data-questionid="'.concat(questionid,'"]')).data("models");let modelid=null;if(modelsdata){const modelids=modelsdata.split(",");modelids.length>0&&(modelid=parseInt(modelids[0],10))}if(!modelid)return void _notification.default.addNotification({message:"No model available",type:"error"});input.prop("disabled",!0),button.prop("disabled",!0),input.val("");const tempId="temp-user-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);displayUserMessage(questionid,message,tempId);const loading=(0,_jquery.default)("#chat-loading-".concat(questionid));loading.show(),sendMessage(cmid,pageid,questionid,message,modelid,button,input,loading)})),(0,_jquery.default)(document).on("keydown",".chat-input",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),(0,_jquery.default)(this).closest(".ai-conversation-container").find(".chat-send-btn").click())})),initialized=!0)};const displayUserMessage=function(questionid,message){let messageid=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const messagesContainer=(0,_jquery.default)("#chat-messages-".concat(questionid)),placeholder=messagesContainer.find(".text-muted.text-center");if(placeholder.length>0&&placeholder.remove(),messageid){if(messagesContainer.find('[data-messageid="'.concat(messageid,'"]')).length>0)return}const recentMessages=messagesContainer.find(".message").slice(-3);let isDuplicate=!1;if(recentMessages.each((function(){if((0,_jquery.default)(this).find(".content").text().trim()===message.trim())return isDuplicate=!0,!1})),!isDuplicate||messageid){if(messageid){if(messagesContainer.find('[data-messageid="'.concat(messageid,'"]')).length>0)return}_templates.default.render("mod_harpiasurvey/chat_user_message",{content:message,id:messageid||"temp-"+Date.now()}).then((html=>{if(messageid){if(messagesContainer.find('[data-messageid="'.concat(messageid,'"]')).length>0)return}_templates.default.appendNodeContents(messagesContainer[0],html),setTimeout((()=>{scrollToBottom(questionid)}),50)})).catch((()=>{if(messageid){if(messagesContainer.find('[data-messageid="'.concat(messageid,'"]')).length>0)return}const messageHtml='<div class="message my-3" data-messageid="'+(messageid||"temp-"+Date.now())+'"><div class="d-flex justify-content-end"><div class="border rounded p-2 bg-primary text-white" style="max-width: 80%;"><div class="content">'+message+"</div></div></div></div>";messagesContainer.append(messageHtml),setTimeout((()=>{scrollToBottom(questionid)}),50)}))}},sendMessage=(cmid,pageid,questionid,message,modelid,button,input,loading)=>{const params=new URLSearchParams({action:"send_ai_message",cmid:cmid,pageid:pageid,questionid:questionid,message:message,modelid:modelid,sesskey:_config.default.sesskey});fetch(_config.default.wwwroot+"/mod/harpiasurvey/ajax.php?"+params.toString(),{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>{if(!response.ok)throw new Error("HTTP error! status: "+response.status);return response.json()})).then((data=>{if(loading.hide(),data.success){if(data.parentid){const userMessages=(0,_jquery.default)("#chat-messages-".concat(questionid)).find(".message").filter((function(){return(0,_jquery.default)(this).find(".bg-primary").length>0}));if(userMessages.length>0){const lastUserMsg=userMessages.last(),currentId=lastUserMsg.attr("data-messageid");currentId&&currentId.startsWith("temp-")&&lastUserMsg.attr("data-messageid",data.parentid)}}data.messageid&&data.content?((questionid,content,messageid)=>{const messagesContainer=(0,_jquery.default)("#chat-messages-".concat(questionid));if(!messageid)return void console.error("displayAIMessage called without messageid");if(!content)return void console.error("displayAIMessage called without content");messagesContainer.find('[data-messageid="'.concat(messageid,'"]')).length>0?console.log("AI message already displayed:",messageid):_templates.default.render("mod_harpiasurvey/chat_ai_message",{id:messageid,content:content}).then((html=>{messagesContainer.find('[data-messageid="'.concat(messageid,'"]')).length>0||(_templates.default.appendNodeContents(messagesContainer[0],html),setTimeout((()=>{scrollToBottom(questionid)}),50))})).catch((()=>{if(messagesContainer.find('[data-messageid="'.concat(messageid,'"]')).length>0)return;const messageHtml='<div class="message my-3" data-messageid="'+messageid+'"><div class="d-flex"><div class="border rounded p-2 bg-light" style="max-width: 80%;"><div class="content">'+content+"</div></div></div></div>";messagesContainer.append(messageHtml),setTimeout((()=>{scrollToBottom(questionid)}),50)}))})(questionid,data.content,data.messageid):_notification.default.addNotification({message:"Received response but missing message ID or content",type:"error"})}else _notification.default.addNotification({message:data.message||"Error sending message",type:"error"});input.prop("disabled",!1),button.prop("disabled",!1),input.focus()})).catch((error=>{loading.hide(),console.error("Error sending message:",error),_notification.default.addNotification({message:"Error sending message: "+error.message,type:"error"}),input.prop("disabled",!1),button.prop("disabled",!1),input.focus()}))},scrollToBottom=questionid=>{const messagesContainer=(0,_jquery.default)("#chat-messages-".concat(questionid));0!==messagesContainer.length&&requestAnimationFrame((()=>{const container=messagesContainer[0];container&&(container.scrollTop=container.scrollHeight)}))}}));

//# sourceMappingURL=ai_conversation.min.js.map